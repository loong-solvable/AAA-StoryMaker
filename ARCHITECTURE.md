# 📐 Infinite Story - 系统架构文档

## 🎯 项目概述

**Infinite Story（无限故事机）** 是一个基于大语言模型的生成式互动叙事游戏引擎。系统通过多Agent协作，将静态小说转化为可交互的动态世界。

---

## 🏗️ 整体架构

### 两大阶段

```
┌─────────────────────────────────────────────────────────────┐
│                    Infinite Story 系统                        │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌───────────────────────┐      ┌───────────────────────┐  │
│  │   离线构建阶段          │      │   在线运行阶段         │  │
│  │  (The Creator)        │ ───> │  (The Runtime)        │  │
│  │                       │      │                       │  │
│  │  • 读取小说            │      │  • 游戏世界模拟        │  │
│  │  • 提取世界观          │      │  • 玩家交互            │  │
│  │  • 生成Genesis.json   │      │  • 剧情推进            │  │
│  │                       │      │  • 动态内容生成        │  │
│  └───────────────────────┘      └───────────────────────┘  │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

---

## 📦 第一阶段：离线构建（✅ 已实现）

### 架构师 (The Architect)

```
┌──────────────────────────────────────────────────────────────┐
│                    The Architect (架构师)                      │
│                        ETL 引擎                               │
└──────────────────────────────────────────────────────────────┘
                             │
                             ▼
              ┌──────────────────────────┐
              │   读取小说文本 (*.txt)     │
              └──────────────────────────┘
                             │
                             ▼
              ┌──────────────────────────┐
              │  LLM 深度解析与提取       │
              │  • 世界观设定             │
              │  • 角色档案               │
              │  • 地点信息               │
              │  • 剧情节点               │
              │  • 初始场景               │
              └──────────────────────────┘
                             │
                             ▼
              ┌──────────────────────────┐
              │   结构化数据验证           │
              └──────────────────────────┘
                             │
                             ▼
              ┌──────────────────────────┐
              │   生成 Genesis.json       │
              │   (世界数据包)            │
              └──────────────────────────┘
```

### Genesis.json 数据结构

```json
{
  "world": {
    "title": "世界名称",
    "genre": "世界类型",
    "time_period": "时代",
    "world_rules": "世界规则"
  },

  
  "characters": [
    {
    "id": "npc_unique_id",       // [String] 唯一标识符 (如: "npc_001")
    "name": "角色真名",          // [String] (如: "韩立" 或 "Linda")
    "gender": "性别",            // [String] (如: "男", "女", "无性", "未知")
    "age": "年龄描述",           // [String] 允许模糊描述 (如: "25岁", "外表12岁实际千岁", "未知")
    
    "importance": 0.8,           // [Float] 0 - 100
                                 // 剧情分配权重。决定了"命运编织者"让他在新剧情里露脸的频率。
                                 // 100 = 当前场景的主角/大反派; 5 = 路人甲

      "traits": [                  // [List<String>] 本质标签
      "标签1",                   // 身份标签 (如: "CEO", "剑修")
      "标签2",                   // 性格标签 (如: "腹黑", "社恐")
      "标签3"                    // 状态标签 (如: "重伤", "破产")
    ],
  
    "behavior_rules": [          // [List<String>] 行为逻辑准则
      "规则1",                   // 决策偏好 (如: "利益最大化，不讲情面")
      "规则2",                   // 情感模式 (如: "面对异性容易害羞")
      "规则3"                    // 特殊限制 (如: "绝不使用火系法术")
    ],
  
    // ==========================================
    // 3. 社交矩阵 (Relationship Matrix)
    // ==========================================
    // 定义该角色"眼中的别人"。key 为目标角色的 id (或 'user')
    "relationship_matrix": {
      "user": {
        "address_as": "称呼",    // [String] 他怎么叫这个目标 (如: "前辈", "那个废物", "亲爱的")
        "attitude": "态度摘要",  // [String] 简述关系基调 (如: "表面恭敬实则提防")
      },
      "npc_002": {
        "address_as": "老张",
        "attitude": "信任",
      }
    },
  
    // ==========================================
    // 4. 资产与外观 (Assets & Visuals)
    // ==========================================
    "possessions": [             // [List<String>] 关键持有物
      "物品名称"                 // 当前场景中身上携带的物品
      "物品名称"                 // 当前场景中身上携带的物品
      "物品名称"                 // 资产（银行账户、房地产等）
    ],
  
    "current_appearance": "外观描述", // [String]
                                     // 供"氛围感受者"描写画面使用。
                                     // (如: "身穿黑色风衣，眼角有一道明显的刀然，神情疲惫。")
  
    // 5. 语言样本 (Mimesis Data)
    "voice_samples": [           // [List<String>] 语言样本
      "原文台词 1",              // 必须保留原著的标点和语气词
      "原文台词 2",
      "原文台词 3"
    ]
    },
    // ... 更多NPC角色
  








  ],
  "locations": [
    {
      "id": "loc_001",
      "name": "地点名",
      "description": "描述"
    }
  ],
  "plot_hints": [
    {
      "id": "hint_001",
      "title": "剧情线索标题",
      "description": "线索描述",
      "importance": 85.0,            // [Float] 0.0 - 100.0，线索的剧情权重
      "related_characters": ["npc_001", "npc_002"],  // 相关角色ID列表
      "status": "潜在",             // [String] 潜在 / 进行中 / 已完成 / 已放弃
      "note_for_plot_agent": "给Plot Agent的提示信息，说明这个线索的性质和用途"
    }
  ],

  // ==========================================
  // ⚠️ 重要设计原则：开放世界 vs 分支剧情
  // ==========================================
  // plot_hints 是"剧情线索库"，NOT "分支剧情树"！
  //
  // ❌ 错误设计：
  //   - 预设 triggers（"玩家答应帮忙" / "玩家拒绝帮忙"）
  //   - 硬编码的 consequences（"进入XX线"）
  //   - 固定的 requires 依赖关系
  //
  // ✅ 正确设计：
  //   - plot_hints 只是给 Plot Agent 的"灵感提示"
  //   - Plot Agent 根据玩家的**实际行为**动态决定剧情走向
  //   - 玩家可以说任何话、做任何事，不受预设选项限制
  //   - NPC 根据自己的 behavior_rules 自然反应，不是按脚本表演
  //
  // 示例：
  //   假设 hint_001 是"苏晴雨需要帮忙解密数据"
  //   - 玩家可能：答应帮忙 / 拒绝 / 讨价还价 / 先问清楚情况 / 
  //             转移话题 / 推荐其他人 / 说"我现在很忙" / ...
  //   - Plot Agent 应该根据玩家的实际输入，结合当前世界状态，
  //     动态编写剧本，而不是查表匹配预设分支
  // ==========================================

  "initial_scene": {
    "description": "初始场景描述",
    "location": "loc_001",
    "present_characters": ["char_001"]
  }
}
```

---

## 🎮 第二阶段：在线运行（🔜 未来实现）

### 三层Agent架构

```
┌─────────────────────────────────────────────────────────────┐
│                        用户 (User)                            │
└─────────────────────────────────────────────────────────────┘
                             ▲ │
                             │ ▼
┌─────────────────────────────────────────────────────────────┐
│                    第一层：安检与中枢                          │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌──────────────────────┐      ┌──────────────────────┐    │
│  │  逻辑审查官 (Logic)   │ <──> │  信息中枢 (OS)        │    │
│  │  • 输入验证           │      │  • 消息路由           │    │
│  │  • 输出审查           │      │  • 状态管理           │    │
│  │  • 幻觉检测           │      │  • Agent协调          │    │
│  └──────────────────────┘      └──────────────────────┘    │
│                                                               │
└─────────────────────────────────────────────────────────────┘
                             ▲ │
                             │ ▼
┌─────────────────────────────────────────────────────────────┐
│                    第二层：光明会（逻辑大脑）                  │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ 世界状态运行者│  │ 命运编织者    │  │ 氛围感受者    │      │
│  │    (WS)      │  │   (Plot)     │  │   (Vibe)     │      │
│  │              │  │              │  │              │      │
│  │ • 时间流逝   │  │ • 剧情走向   │  │ • 环境描写   │      │
│  │ • NPC状态    │  │ • 高潮控制   │  │ • 感官细节   │      │
│  │ • 离屏事件   │  │ • 情绪指导   │  │ • 氛围渲染   │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
│                                                               │
└─────────────────────────────────────────────────────────────┘
                             ▲ │
                             │ ▼
┌─────────────────────────────────────────────────────────────┐
│                    第三层：演员组（表现层）                     │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │
│  │ NPC-001  │  │ NPC-002  │  │ NPC-003  │  │   ...    │   │
│  │          │  │          │  │          │  │          │   │
│  │ • 台词   │  │ • 行为   │  │ • 情绪   │  │ • 反应   │   │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘   │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

### 游戏回合流程

```
用户输入
   │
   ▼
┌─────────────────────────────────────────────────────────┐
│ 1. 消息接收与路由                                          │
│    OS: 接收用户输入 → 转发给Logic审查                       │
│    日志: 记录原始用户输入                                   │
└─────────────────────────────────────────────────────────┘
   │
   ▼
┌─────────────────────────────────────────────────────────┐
│ 2. 输入验证与打戳                                          │
│    Logic: 世界观一致性检查 + 逻辑合法性判断                  │
│    - 通过: 打上验证戳 → 返回OS                             │
│    - 拒绝: 生成拒绝理由 → 返回用户                          │
│    日志: 记录审查结果和决策依据                             │
└─────────────────────────────────────────────────────────┘
   │
   ▼
┌─────────────────────────────────────────────────────────┐
│ 3. 信息聚合与编剧                                          │
│    OS: 将验证后的输入传输给Plot                            │
│    Plot: 并行从WS和Vibe拉取最新状态                        │
│         ├─ WS: 当前世界状态(NPC位置/状态/时间)             │
│         └─ Vibe: 当前氛围与环境信息                        │
│    Plot: 根据【用户输入 + WS + Vibe】编写新剧本            │
│    日志: 记录Plot决策过程和剧本草稿                         │
└─────────────────────────────────────────────────────────┘
   │
   ▼
┌─────────────────────────────────────────────────────────┐
│ 4. 状态更新（逆向同步）                                     │
│    Plot发布新剧本 →                                        │
│         ├─ WS: 更新NPC状态/位置/时间/离屏事件              │
│         └─ Vibe: 更新环境变化/氛围指标                     │
│    日志: 记录WS和Vibe的状态变更（diff格式）                 │
└─────────────────────────────────────────────────────────┘
   │
   ▼
┌─────────────────────────────────────────────────────────┐
│ 5. 剧本分发（智能拆解）                                     │
│    Plot → OS: 发送完整剧本                                 │
│    OS: 为每个NPC提取专属戏份                               │
│        - 解析剧本中的NPC角色                               │
│        - 提取该NPC的台词/行为/情绪指令                      │
│        - 附带场景上下文和对手戏信息                         │
│    OS → NPC Agents: 特异性分发                            │
│    日志: 记录剧本分发清单和每个NPC接收的内容                 │
└─────────────────────────────────────────────────────────┘
   │
   ▼
┌─────────────────────────────────────────────────────────┐
│ 6. 演员演绎                                               │
│    各NPC Agent并行执行:                                    │
│         - 根据自身角色卡(性格/语言样本)                     │
│         - 演绎分配的戏份                                   │
│         - 生成台词和行为描述                               │
│    返回结果 → OS                                          │
│    日志: 记录每个NPC的演绎输出                             │
└─────────────────────────────────────────────────────────┘
   │
   ▼
┌─────────────────────────────────────────────────────────┐
│ 7. 内容整合与输出                                          │
│    OS: 收集所有NPC演绎成果                                 │
│    OS: 按时间线/逻辑顺序拼接文本                           │
│    OS: 可选 - 让Vibe润色最终输出的氛围描写                  │
│    展示给用户                                             │
│    日志: 记录最终输出内容和整合过程                         │
└─────────────────────────────────────────────────────────┘
```

#### 关键流程说明

**📥 输入阶段（步骤1-2）**  
- OS作为唯一入口，确保消息可追溯
- Logic作为守门人，防止破坏世界观的输入

**🎬 编剧阶段（步骤3-4）**  
- Plot是核心决策者，拥有剧情走向的最高权限
- WS和Vibe作为信息提供者，**被动接受**Plot的状态更新

**🎭 表演阶段（步骤5-7）**  
- OS负责智能拆解，确保每个NPC只看到自己的戏份
- NPC Agent并行演绎，提高响应速度
- OS最终整合，保证输出的连贯性

**📊 日志贯穿全流程**  
- 每个步骤都记录详细日志
- 重点追踪Agent状态变化（WS/Vibe/Plot的记忆更新）
- 为未来的角色卡动态更新机制预留审计能力

---

## 🔧 技术架构

### 核心模块

```
┌──────────────────────────────────────────────────────────┐
│                       Core Modules                        │
├──────────────────────────────────────────────────────────┤
│                                                            │
│  ┌─────────────┐   ┌─────────────┐   ┌─────────────┐   │
│  │  LLM Factory│   │   Logger    │   │   Config    │   │
│  │  ────────── │   │  ──────────  │   │  ──────────  │   │
│  │  • 智谱清言  │   │  • 彩色输出  │   │  • .env加载  │   │
│  │  • OpenAI   │   │  • 文件持久  │   │  • 路径管理  │   │
│  │  • 讯飞星火  │   │  • 多级别    │   │  • 验证      │   │
│  │  • 统一接口  │   │  • 状态追踪  │   │  • 热加载    │   │
│  └─────────────┘   └─────────────┘   └─────────────┘   │
│                                                            │
└──────────────────────────────────────────────────────────┘
```

### 日志系统架构（Logger）

日志系统是整个项目的"黑匣子"，负责追踪所有Agent的行为和状态变化。

#### 日志分类

```
logs/
├── runtime/                     # 运行时日志
│   ├── game_YYYYMMDD.log       #   - 游戏主日志（每日轮转）
│   ├── os_YYYYMMDD.log          #   - 信息中枢专用日志
│   └── errors_YYYYMMDD.log      #   - 错误汇总日志
│
├── agents/                      # Agent状态追踪
│   ├── logic_YYYYMMDD.log       #   - Logic决策日志
│   ├── plot_YYYYMMDD.log        #   - Plot编剧日志
│   ├── ws_YYYYMMDD.log          #   - WS状态变更日志
│   ├── vibe_YYYYMMDD.log        #   - Vibe氛围变更日志
│   └── npcs/                    #   - NPC演绎日志
│       ├── npc_001_YYYYMMDD.log
│       ├── npc_002_YYYYMMDD.log
│       └── ...
│
├── memory_changes/              # 记忆变更审计（核心功能）
│   ├── ws_memory_diff.jsonl     #   - WS状态diff记录
│   ├── vibe_memory_diff.jsonl   #   - Vibe状态diff记录
│   ├── plot_memory_diff.jsonl   #   - Plot记忆diff记录
│   └── character_cards_diff.jsonl # - 角色卡变更记录（未来）
│
└── architect/                   # 离线构建日志
    └── build_YYYYMMDD.log       #   - Genesis生成日志
```

#### 记忆变更追踪格式

所有记忆变更使用JSONL格式（每行一个JSON对象）：

```jsonl
{"timestamp": "2024-11-26T14:30:00", "agent": "WS", "type": "npc_state_update", "npc_id": "npc_001", "field": "location", "old_value": "loc_001", "new_value": "loc_002", "trigger": "script_042"}
{"timestamp": "2024-11-26T14:30:05", "agent": "Vibe", "type": "atmosphere_update", "field": "tension_level", "old_value": 3, "new_value": 7, "trigger": "combat_started"}
{"timestamp": "2024-11-26T14:30:10", "agent": "Plot", "type": "script_generated", "script_id": "script_042", "involved_npcs": ["npc_001", "npc_003"], "plot_importance": 0.8}
```

#### 日志级别

```python
DEBUG    # 调试信息（开发阶段）
INFO     # 常规信息（Agent正常操作）
WARNING  # 警告（如：NPC行为偏离剧本）
ERROR    # 错误（如：LLM调用失败）
CRITICAL # 严重错误（如：世界状态损坏）
```

#### 日志功能需求

1. **实时控制台输出**：使用彩色日志增强可读性
2. **文件持久化**：按日期和Agent类型分类存储
3. **状态diff追踪**：记录每次Agent记忆更新的前后对比
4. **查询接口**：支持按时间/Agent/事件类型查询
5. **性能优化**：异步写入，避免阻塞游戏流程

### 数据流

```
┌─────────┐      ┌─────────┐      ┌─────────┐      ┌─────────┐
│ 小说文本  │ ───> │ LLM处理  │ ───> │Genesis  │ ───> │ 游戏世界 │
│ (*.txt) │      │ (解析)   │      │ (.json) │      │ (运行时) │
└─────────┘      └─────────┘      └─────────┘      └─────────┘
```

### Agent通信协议

所有Agent间通信使用JSON格式，通过信息中枢(OS)转发：

```json
{
  "from": "agent_id",
  "to": "agent_id",
  "type": "message_type",
  "payload": {
    "data": "具体内容"
  },
  "timestamp": "2024-11-24T12:00:00"
}
```

---

## 📂 目录结构映射

```
AAA-StoryMaker/
│
├── agents/                    # Agent实现层
│   ├── offline/              # 离线构建（✅ 实现）
│   │   └── architect.py      #   - The Architect
│   └── online/               # 在线运行（🔜 未来）
│       ├── layer1/           #   - Logic + OS
│       ├── layer2/           #   - WS + Plot + Vibe
│       └── layer3/           #   - NPC Agents
│
├── prompts/                   # Prompt工程层
│   ├── offline/              #   - 架构师提示词
│   └── online/               #   - 运行时Agents提示词
│
├── utils/                     # 工具层
│   ├── llm_factory.py        #   - LLM抽象
│   └── logger.py             #   - 日志系统
│
├── config/                    # 配置层
│   └── settings.py           #   - 环境配置
│
├── data/                      # 数据层
│   ├── novels/               #   - 输入：小说
│   └── genesis/              #   - 输出：世界数据
│
└── logs/                      # 日志层
```

---

## 🎨 设计原则

### 1. 低耦合 (Low Coupling)
- Agent独立运行，通过OS通信
- LLM提供商可随意切换
- 模块职责清晰

### 2. 高内聚 (High Cohesion)
- 每个Agent专注单一职责
- 工具模块功能明确
- Prompt统一管理

### 3. 可扩展性 (Extensibility)
- 新增Agent无需修改现有代码
- 支持多种LLM提供商
- 数据格式标准化

### 4. 可维护性 (Maintainability)
- 完整的中文注释
- 详细的日志记录
- 清晰的目录结构

---

## 🚀 技术栈

| 层级 | 技术 | 用途 |
|------|------|------|
| AI框架 | LangChain | Multi-Agent开发 |
| LLM | 智谱清言 GLM-4 | 主要推理引擎 |
| 配置 | python-dotenv | 环境变量管理 |
| 日志 | colorlog | 彩色日志输出 |
| 数据 | JSON | 结构化存储 |
| 语言 | Python 3.9+ | 开发语言 |

---

## 📊 系统状态

### ✅ 已实现（v0.1.0）
- [x] 项目架构设计
- [x] 基础设施（Config/Logger/LLM Factory）
- [x] 架构师Agent
- [x] Prompt工程
- [x] Genesis数据生成

### 🔜 待实现（v0.2.0+）
- [ ] 信息中枢OS
- [ ] 逻辑审查官Logic
- [ ] 光明会三Agent（WS/Plot/Vibe）
- [ ] NPC动态生成
- [ ] CLI交互界面
- [ ] 游戏存档系统

---

## 📖 参考文档

- [README.md](./README.md) - 快速开始指南
- [工作报告](./工作报告-第1次-2024年11月24日.md) - 开发日志
- [draft.md](./draft.md) - 原始需求文档

---

---

## 📝 更新日志

### 2024年11月26日 - 架构优化
- ✅ 完善游戏回合流程，明确OS作为消息中枢的职责
- ✅ 强化日志系统架构，支持Agent状态变更追踪
- ✅ 优化角色卡JSON结构，清理重复内容
- ✅ 修正"刀然"为"刀疤"（typo fix）

### 2024年11月24日 - 初始版本
- ✅ 项目架构设计
- ✅ 基础设施实现
- ✅ 架构师Agent实现

---

**最后更新：** 2024年11月26日  
**当前版本：** v0.1.0  
**下一里程碑：** v0.2.0 - 信息中枢与逻辑审查

