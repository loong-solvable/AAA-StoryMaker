# 📐 Infinite Story - 系统架构文档

## 🎯 项目概述

**Infinite Story（无限故事机）** 是一个基于大语言模型的生成式互动叙事游戏引擎。系统通过多Agent协作，将静态小说转化为可交互的动态世界。

---

## 🏗️ 整体架构

### 两大阶段

```
┌─────────────────────────────────────────────────────────────┐
│                    Infinite Story 系统                        │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌───────────────────────┐      ┌───────────────────────┐  │
│  │   离线构建阶段          │      │   在线运行阶段         │  │
│  │  (The Creator)        │ ───> │  (The Runtime)        │  │
│  │                       │      │                       │  │
│  │  • 读取小说            │      │  • 游戏世界模拟        │  │
│  │  • 提取世界观          │      │  • 玩家交互            │  │
│  │  • 生成Genesis.json   │      │  • 剧情推进            │  │
│  │                       │      │  • 动态内容生成        │  │
│  └───────────────────────┘      └───────────────────────┘  │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

---

## 📦 第一阶段：离线构建（✅ 已实现）

### 架构师 (The Architect)

```
┌──────────────────────────────────────────────────────────────┐
│                    The Architect (架构师)                      │
│                        ETL 引擎                               │
└──────────────────────────────────────────────────────────────┘
                             │
                             ▼
              ┌──────────────────────────┐
              │   读取小说文本 (*.txt)     │
              └──────────────────────────┘
                             │
                             ▼
              ┌──────────────────────────┐
              │  LLM 深度解析与提取       │
              │  • 世界观设定             │
              │  • 角色档案               │
              │  • 地点信息               │
              │  • 剧情节点               │
              │  • 初始场景               │
              └──────────────────────────┘
                             │
                             ▼
              ┌──────────────────────────┐
              │   结构化数据验证           │
              └──────────────────────────┘
                             │
                             ▼
              ┌──────────────────────────┐
              │   生成 Genesis.json       │
              │   (世界数据包)            │
              └──────────────────────────┘
```

### Genesis.json 数据结构

```json
{
  "world": {
    "title": "世界名称",
    "genre": "类型",
    "time_period": "时代",
    "location": "地理位置",
    "world_rules": "世界规则"
  },
  "characters": [
    {
      "id": "char_001",
      "name": "角色名",
      "personality": "性格",
      "background": "背景",
      "relationships": {}
    }
  ],
  "locations": [
    {
      "id": "loc_001",
      "name": "地点名",
      "description": "描述"
    }
  ],
  "plot_nodes": [
    {
      "id": "plot_001",
      "title": "剧情节点",
      "trigger_condition": "触发条件",
      "importance": "重要性"
    }
  ],
  "initial_scene": {
    "description": "初始场景描述",
    "location": "loc_001",
    "present_characters": ["char_001"]
  }
}
```

---

## 🎮 第二阶段：在线运行（🔜 未来实现）

### 三层Agent架构

```
┌─────────────────────────────────────────────────────────────┐
│                        用户 (User)                            │
└─────────────────────────────────────────────────────────────┘
                             ▲ │
                             │ ▼
┌─────────────────────────────────────────────────────────────┐
│                    第一层：安检与中枢                          │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌──────────────────────┐      ┌──────────────────────┐    │
│  │  逻辑审查官 (Logic)   │ <──> │  信息中枢 (OS)        │    │
│  │  • 输入验证           │      │  • 消息路由           │    │
│  │  • 输出审查           │      │  • 状态管理           │    │
│  │  • 幻觉检测           │      │  • Agent协调          │    │
│  └──────────────────────┘      └──────────────────────┘    │
│                                                               │
└─────────────────────────────────────────────────────────────┘
                             ▲ │
                             │ ▼
┌─────────────────────────────────────────────────────────────┐
│                    第二层：光明会（逻辑大脑）                  │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ 世界状态运行者│  │ 命运编织者    │  │ 氛围感受者    │      │
│  │    (WS)      │  │   (Plot)     │  │   (Vibe)     │      │
│  │              │  │              │  │              │      │
│  │ • 时间流逝   │  │ • 剧情走向   │  │ • 环境描写   │      │
│  │ • NPC状态    │  │ • 高潮控制   │  │ • 感官细节   │      │
│  │ • 离屏事件   │  │ • 情绪指导   │  │ • 氛围渲染   │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
│                                                               │
└─────────────────────────────────────────────────────────────┘
                             ▲ │
                             │ ▼
┌─────────────────────────────────────────────────────────────┐
│                    第三层：演员组（表现层）                     │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │
│  │ NPC-001  │  │ NPC-002  │  │ NPC-003  │  │   ...    │   │
│  │          │  │          │  │          │  │          │   │
│  │ • 台词   │  │ • 行为   │  │ • 情绪   │  │ • 反应   │   │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘   │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

### 游戏回合流程

```
用户输入
   │
   ▼
┌─────────────────┐
│ 1. 输入拦截      │  Logic: 是否符合世界观？
└─────────────────┘
   │
   ▼
┌─────────────────┐
│ 2. 逻辑推演      │  WS + Plot: 计算世界变化 + 剧情走向
└─────────────────┘
   │
   ▼
┌─────────────────┐
│ 3. 分发指令      │  OS: 拆解决策 → Vibe + NPCs
└─────────────────┘
   │
   ▼
┌─────────────────┐
│ 4. 表演生成      │  Vibe + NPCs: 生成文本
└─────────────────┘
   │
   ▼
┌─────────────────┐
│ 5. 输出审查      │  Logic: 检查幻觉和逻辑冲突
└─────────────────┘
   │
   ▼
┌─────────────────┐
│ 6. 最终反馈      │  OS: 拼接文本 → 展示给用户
└─────────────────┘
```

---

## 🔧 技术架构

### 核心模块

```
┌──────────────────────────────────────────────────────────┐
│                       Core Modules                        │
├──────────────────────────────────────────────────────────┤
│                                                            │
│  ┌─────────────┐   ┌─────────────┐   ┌─────────────┐   │
│  │  LLM Factory│   │   Logger    │   │   Config    │   │
│  │  ────────── │   │  ──────────  │   │  ──────────  │   │
│  │  • 智谱清言  │   │  • 彩色输出  │   │  • .env加载  │   │
│  │  • OpenAI   │   │  • 文件持久  │   │  • 路径管理  │   │
│  │  • 讯飞星火  │   │  • 多级别    │   │  • 验证      │   │
│  └─────────────┘   └─────────────┘   └─────────────┘   │
│                                                            │
└──────────────────────────────────────────────────────────┘
```

### 数据流

```
┌─────────┐      ┌─────────┐      ┌─────────┐      ┌─────────┐
│ 小说文本  │ ───> │ LLM处理  │ ───> │Genesis  │ ───> │ 游戏世界 │
│ (*.txt) │      │ (解析)   │      │ (.json) │      │ (运行时) │
└─────────┘      └─────────┘      └─────────┘      └─────────┘
```

### Agent通信协议

所有Agent间通信使用JSON格式，通过信息中枢(OS)转发：

```json
{
  "from": "agent_id",
  "to": "agent_id",
  "type": "message_type",
  "payload": {
    "data": "具体内容"
  },
  "timestamp": "2024-11-24T12:00:00"
}
```

---

## 📂 目录结构映射

```
AAA-StoryMaker/
│
├── agents/                    # Agent实现层
│   ├── offline/              # 离线构建（✅ 实现）
│   │   └── architect.py      #   - The Architect
│   └── online/               # 在线运行（🔜 未来）
│       ├── layer1/           #   - Logic + OS
│       ├── layer2/           #   - WS + Plot + Vibe
│       └── layer3/           #   - NPC Agents
│
├── prompts/                   # Prompt工程层
│   ├── offline/              #   - 架构师提示词
│   └── online/               #   - 运行时Agents提示词
│
├── utils/                     # 工具层
│   ├── llm_factory.py        #   - LLM抽象
│   └── logger.py             #   - 日志系统
│
├── config/                    # 配置层
│   └── settings.py           #   - 环境配置
│
├── data/                      # 数据层
│   ├── novels/               #   - 输入：小说
│   └── genesis/              #   - 输出：世界数据
│
└── logs/                      # 日志层
```

---

## 🎨 设计原则

### 1. 低耦合 (Low Coupling)
- Agent独立运行，通过OS通信
- LLM提供商可随意切换
- 模块职责清晰

### 2. 高内聚 (High Cohesion)
- 每个Agent专注单一职责
- 工具模块功能明确
- Prompt统一管理

### 3. 可扩展性 (Extensibility)
- 新增Agent无需修改现有代码
- 支持多种LLM提供商
- 数据格式标准化

### 4. 可维护性 (Maintainability)
- 完整的中文注释
- 详细的日志记录
- 清晰的目录结构

---

## 🚀 技术栈

| 层级 | 技术 | 用途 |
|------|------|------|
| AI框架 | LangChain | Multi-Agent开发 |
| LLM | 智谱清言 GLM-4 | 主要推理引擎 |
| 配置 | python-dotenv | 环境变量管理 |
| 日志 | colorlog | 彩色日志输出 |
| 数据 | JSON | 结构化存储 |
| 语言 | Python 3.9+ | 开发语言 |

---

## 📊 系统状态

### ✅ 已实现（v0.1.0）
- [x] 项目架构设计
- [x] 基础设施（Config/Logger/LLM Factory）
- [x] 架构师Agent
- [x] Prompt工程
- [x] Genesis数据生成

### 🔜 待实现（v0.2.0+）
- [ ] 信息中枢OS
- [ ] 逻辑审查官Logic
- [ ] 光明会三Agent（WS/Plot/Vibe）
- [ ] NPC动态生成
- [ ] CLI交互界面
- [ ] 游戏存档系统

---

## 📖 参考文档

- [README.md](./README.md) - 快速开始指南
- [工作报告](./工作报告-第1次-2024年11月24日.md) - 开发日志
- [draft.md](./draft.md) - 原始需求文档

---

**最后更新：** 2024年11月24日  
**当前版本：** v0.1.0  
**下一里程碑：** v0.2.0 - 信息中枢与逻辑审查

