"""
ğŸ­ Infinite Story - æ— é™æ•…äº‹æœº
æ¸¸æˆå…¨æµç¨‹è¿è¡Œå…¥å£

æ¸¸æˆæµç¨‹åˆ†ä¸ºä¸‰å¤§é˜¶æ®µï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é˜¶æ®µ1: ç¦»çº¿æ„å»ºï¼ˆåˆ›ä¸–ç»„ï¼‰                    [âœ… å·²å®Œæˆ]         â”‚
â”‚  â”œâ”€â”€ å¤§ä¸­æ­£: è§’è‰²æ™®æŸ¥                                            â”‚
â”‚  â”œâ”€â”€ Demiurge: ä¸–ç•Œè®¾å®šæå–                                      â”‚
â”‚  â””â”€â”€ è®¸åŠ­: è§’è‰²æ¡£æ¡ˆåˆ¶ä½œ                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  é˜¶æ®µ2: åœ¨çº¿åˆå§‹åŒ–ï¼ˆå…‰æ˜ä¼šï¼‰                  [ğŸ”œ å¾…å¼€å‘]         â”‚
â”‚  â”œâ”€â”€ åˆå§‹åŒ– OSï¼ˆä¿¡æ¯ä¸­æ¢ï¼‰                                       â”‚
â”‚  â”œâ”€â”€ åˆå§‹åŒ– Logicï¼ˆé€»è¾‘å®¡æŸ¥å®˜ï¼‰                                  â”‚
â”‚  â”œâ”€â”€ åˆå§‹åŒ– WSï¼ˆä¸–ç•ŒçŠ¶æ€è¿è¡Œè€…ï¼‰                                 â”‚
â”‚  â”œâ”€â”€ åˆå§‹åŒ– Plotï¼ˆå‘½è¿ç¼–ç»‡è€…ï¼‰                                   â”‚
â”‚  â”œâ”€â”€ åˆå§‹åŒ– Vibeï¼ˆæ°›å›´æ„Ÿå—è€…ï¼‰                                   â”‚
â”‚  â””â”€â”€ åˆå§‹åŒ– NPC Agentsï¼ˆæ¼”å‘˜ç»„ï¼‰                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  é˜¶æ®µ3: æ¸¸æˆè¿è¡Œï¼ˆäº¤äº’å¾ªç¯ï¼‰                  [ğŸ”œ å¾…å¼€å‘]         â”‚
â”‚  â””â”€â”€ ç©å®¶è¾“å…¥ â†’ Logicå®¡æŸ¥ â†’ Plotç¼–å‰§ â†’ OSåˆ†å‘ â†’ NPCæ¼”ç» â†’ è¾“å‡º   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä½¿ç”¨æ–¹æ³•ï¼š
    python run_game.py [é€‰é¡¹]
    
    é€‰é¡¹ï¼š
        --skip-genesis    è·³è¿‡åˆ›ä¸–ç»„é˜¶æ®µï¼ˆå¦‚æœä¸–ç•Œæ•°æ®å·²å­˜åœ¨ï¼‰
        --world <åç§°>    æŒ‡å®šè¦ä½¿ç”¨çš„ä¸–ç•Œåç§°
        --novel <æ–‡ä»¶å>  æŒ‡å®šå°è¯´æ–‡ä»¶åï¼ˆé»˜è®¤: example_novel.txtï¼‰
"""
import sys
import argparse
from pathlib import Path
from config.settings import settings
from utils.logger import setup_logger

logger = setup_logger("GameRunner", "game_runner.log")


def print_banner():
    """æ‰“å°æ¸¸æˆæ¨ªå¹…"""
    print()
    print("=" * 70)
    print("  ğŸ­ Infinite Story - æ— é™æ•…äº‹æœº")
    print("  åŸºäºLangChainçš„ç”Ÿæˆå¼äº’åŠ¨å™äº‹æ¸¸æˆå¼•æ“")
    print("=" * 70)
    print()


def print_stage_header(stage_num: int, stage_name: str, status: str):
    """æ‰“å°é˜¶æ®µæ ‡é¢˜"""
    print()
    print("â”€" * 70)
    print(f"  ğŸ“ é˜¶æ®µ {stage_num}: {stage_name}  [{status}]")
    print("â”€" * 70)
    print()


def stage1_genesis(novel_filename: str = "example_novel.txt", skip: bool = False) -> Path:
    """
    é˜¶æ®µ1: åˆ›ä¸–ç»„ç¦»çº¿æ„å»º
    
    åˆ›ä¸–ç»„æˆå‘˜ï¼š
    - å¤§ä¸­æ­£: è§’è‰²æ™®æŸ¥ä¸é‡è¦æ€§è¯„ä¼°
    - Demiurge: ä¸–ç•Œè§„åˆ™ä¸èƒŒæ™¯æå–
    - è®¸åŠ­: è§’è‰²æ¡£æ¡ˆä¸è§’è‰²å¡åˆ¶ä½œ
    
    Args:
        novel_filename: å°è¯´æ–‡ä»¶å
        skip: æ˜¯å¦è·³è¿‡æ­¤é˜¶æ®µ
    
    Returns:
        ä¸–ç•Œæ•°æ®ç›®å½•è·¯å¾„
    """
    print_stage_header(1, "åˆ›ä¸–ç»„ç¦»çº¿æ„å»º", "âœ… å·²å®Œæˆ")
    
    # æ£€æŸ¥æ˜¯å¦æœ‰ç°æœ‰ä¸–ç•Œæ•°æ®
    worlds_dir = settings.DATA_DIR / "worlds"
    existing_worlds = list(worlds_dir.glob("*/world_setting.json")) if worlds_dir.exists() else []
    
    if skip and existing_worlds:
        # ä½¿ç”¨æœ€æ–°çš„ä¸–ç•Œ
        latest_world = max(existing_worlds, key=lambda p: p.stat().st_mtime)
        world_dir = latest_world.parent
        print(f"  â­ï¸  è·³è¿‡åˆ›ä¸–ç»„é˜¶æ®µ")
        print(f"  ğŸ“ ä½¿ç”¨ç°æœ‰ä¸–ç•Œ: {world_dir.name}")
        logger.info(f"è·³è¿‡åˆ›ä¸–ç»„ï¼Œä½¿ç”¨ç°æœ‰ä¸–ç•Œ: {world_dir}")
        return world_dir
    
    print("  ğŸ“Œ åˆ›ä¸–ç»„ä¸‰é˜¶æ®µæ„å»ºæµç¨‹:")
    print("     1ï¸âƒ£  å¤§ä¸­æ­£ - è§’è‰²æ™®æŸ¥ï¼Œè¯†åˆ«æ‰€æœ‰è§’è‰²å¹¶è¯„ä¼°é‡è¦æ€§")
    print("     2ï¸âƒ£  Demiurge - æå–ä¸–ç•Œè§‚è®¾å®šï¼ˆç‰©ç†æ³•åˆ™ã€ç¤¾ä¼šè§„åˆ™ã€åœ°ç‚¹ï¼‰")
    print("     3ï¸âƒ£  è®¸åŠ­ - ä¸ºæ¯ä¸ªè§’è‰²åˆ›å»ºè¯¦ç»†æ¡£æ¡ˆï¼ˆè§’è‰²å¡ï¼‰")
    print()
    
    # éªŒè¯é…ç½®
    try:
        logger.info("ğŸ” æ­£åœ¨éªŒè¯é…ç½®...")
        settings.validate()
        logger.info("âœ… é…ç½®éªŒè¯é€šè¿‡")
    except ValueError as e:
        logger.error(str(e))
        print("  âŒ é…ç½®éªŒè¯å¤±è´¥ï¼")
        print()
        print("  è¯·æŒ‰ä»¥ä¸‹æ­¥éª¤é…ç½®ï¼š")
        print("  1. å¤åˆ¶ .env.example ä¸º .env")
        print("  2. ç¼–è¾‘ .env æ–‡ä»¶ï¼Œå¡«å…¥ä½ çš„APIå¯†é’¥")
        print("  3. ä¿å­˜åé‡æ–°è¿è¡Œæœ¬è„šæœ¬")
        sys.exit(1)
    
    # ç¡®ä¿ç›®å½•å­˜åœ¨
    settings.ensure_directories()
    
    # è¿è¡Œåˆ›ä¸–ç»„
    try:
        from agents.offline.genesis_group import create_world
        
        logger.info(f"ğŸš€ å¯åŠ¨åˆ›ä¸–ç»„ï¼Œå¤„ç†å°è¯´: {novel_filename}")
        world_dir = create_world(novel_filename)
        
        print()
        print("  âœ… ä¸–ç•Œæ„å»ºæˆåŠŸï¼")
        print(f"  ğŸ“ ä¸–ç•Œæ•°æ®: {world_dir}")
        print()
        print("  ğŸ“– ç”Ÿæˆçš„æ–‡ä»¶ï¼š")
        print(f"     - world_setting.json      # Demiurge ç”Ÿæˆçš„ä¸–ç•Œè§‚è®¾å®š")
        print(f"     - characters_list.json    # å¤§ä¸­æ­£ ç”Ÿæˆçš„è§’è‰²åˆ—è¡¨")
        print(f"     - characters/             # è®¸åŠ­ ç”Ÿæˆçš„è§’è‰²è¯¦ç»†æ¡£æ¡ˆ")
        print()
        
        logger.info(f"âœ… é˜¶æ®µ1å®Œæˆ: {world_dir}")
        return world_dir
        
    except FileNotFoundError as e:
        logger.error(f"âŒ æ–‡ä»¶æœªæ‰¾åˆ°: {e}")
        print(f"  âŒ è¿è¡Œå¤±è´¥ï¼šæ‰¾ä¸åˆ°å°è¯´æ–‡ä»¶")
        print(f"  è¯·ç¡®ä¿æ–‡ä»¶å­˜åœ¨: {settings.NOVELS_DIR}/{novel_filename}")
        sys.exit(1)
        
    except Exception as e:
        logger.error(f"âŒ åˆ›ä¸–ç»„è¿è¡Œå¤±è´¥: {e}", exc_info=True)
        print(f"  âŒ è¿è¡Œå¤±è´¥: {e}")
        print(f"  è¯·æŸ¥çœ‹æ—¥å¿—: {settings.LOGS_DIR}/genesis_group.log")
        sys.exit(1)


def stage2_initialize(world_dir: Path):
    """
    é˜¶æ®µ2: åœ¨çº¿åˆå§‹åŒ–ï¼ˆå…‰æ˜ä¼šï¼‰
    
    åˆå§‹åŒ–å†…å®¹ï¼š
    - OSï¼ˆä¿¡æ¯ä¸­æ¢ï¼‰: å‰§æœ¬æ‹†åˆ†ä¸åˆ†å‘
    - Logicï¼ˆé€»è¾‘å®¡æŸ¥å®˜ï¼‰: è¾“å…¥è¾“å‡ºå®¡æ ¸
    - WSï¼ˆä¸–ç•ŒçŠ¶æ€è¿è¡Œè€…ï¼‰: ä¸–ç•Œä»¿çœŸ
    - Plotï¼ˆå‘½è¿ç¼–ç»‡è€…ï¼‰: å‰§æƒ…ç¼–ç»‡
    - Vibeï¼ˆæ°›å›´æ„Ÿå—è€…ï¼‰: ç¯å¢ƒæ¸²æŸ“
    - NPC Agentsï¼ˆæ¼”å‘˜ç»„ï¼‰: è§’è‰²æ‰®æ¼”
    
    Args:
        world_dir: ä¸–ç•Œæ•°æ®ç›®å½•
    """
    print_stage_header(2, "åœ¨çº¿åˆå§‹åŒ–ï¼ˆå…‰æ˜ä¼šï¼‰", "ğŸ”œ å¾…å¼€å‘")
    
    print("  ğŸ“‹ å¾…åˆå§‹åŒ–çš„ç»„ä»¶ï¼š")
    print()
    print("  ç¬¬ä¸€å±‚ - å®‰æ£€ä¸ä¸­æ¢")
    print("     â€¢ OSï¼ˆä¿¡æ¯ä¸­æ¢ï¼‰: å‰§æœ¬æ‹†åˆ†ã€æ¶ˆæ¯åˆ†å‘ã€çŠ¶æ€ç®¡ç†")
    print("     â€¢ Logicï¼ˆé€»è¾‘å®¡æŸ¥å®˜ï¼‰: è¾“å…¥éªŒè¯ã€è¾“å‡ºå®¡æŸ¥ã€å¹»è§‰æ£€æµ‹")
    print()
    print("  ç¬¬äºŒå±‚ - å…‰æ˜ä¼šï¼ˆé€»è¾‘å¤§è„‘ï¼‰")
    print("     â€¢ WSï¼ˆä¸–ç•ŒçŠ¶æ€è¿è¡Œè€…ï¼‰: æ—¶é—´æµé€ã€NPCçŠ¶æ€ã€ç¦»å±äº‹ä»¶")
    print("     â€¢ Plotï¼ˆå‘½è¿ç¼–ç»‡è€…ï¼‰: å‰§æƒ…èµ°å‘ã€é«˜æ½®æ§åˆ¶ã€æƒ…ç»ªæŒ‡å¯¼")
    print("     â€¢ Vibeï¼ˆæ°›å›´æ„Ÿå—è€…ï¼‰: ç¯å¢ƒæå†™ã€æ„Ÿå®˜ç»†èŠ‚ã€æ°›å›´æ¸²æŸ“")
    print()
    print("  ç¬¬ä¸‰å±‚ - æ¼”å‘˜ç»„ï¼ˆè¡¨ç°å±‚ï¼‰")
    print("     â€¢ NPC Agents: æ ¹æ®è§’è‰²å¡æ‰®æ¼”å„ä¸ªè§’è‰²")
    print()
    print("  â³ æ­¤é˜¶æ®µå°šæœªå®ç°ï¼Œè¯·è¿è¡Œ run_initial.pyï¼ˆå¾…å¼€å‘ï¼‰")
    print()
    
    logger.info("é˜¶æ®µ2å°šæœªå®ç°")


def stage3_game_loop(world_dir: Path):
    """
    é˜¶æ®µ3: æ¸¸æˆè¿è¡Œï¼ˆäº¤äº’å¾ªç¯ï¼‰
    
    æ¸¸æˆå›åˆæµç¨‹ï¼š
    1. æ¥æ”¶ç”¨æˆ·è¾“å…¥
    2. Logic å®¡æŸ¥è¾“å…¥åˆæ³•æ€§
    3. Plot ç¼–ç»‡æ–°å‰§æœ¬
    4. OS æ‹†åˆ†å‰§æœ¬å¹¶åˆ†å‘
    5. NPC Agents æ¼”ç»è§’è‰²
    6. æ•´åˆè¾“å‡ºå±•ç¤ºç»™ç©å®¶
    
    Args:
        world_dir: ä¸–ç•Œæ•°æ®ç›®å½•
    """
    print_stage_header(3, "æ¸¸æˆè¿è¡Œï¼ˆäº¤äº’å¾ªç¯ï¼‰", "ğŸ”œ å¾…å¼€å‘")
    
    print("  ğŸ® æ¸¸æˆå›åˆæµç¨‹ï¼š")
    print()
    print("     ç”¨æˆ·è¾“å…¥")
    print("        â”‚")
    print("        â–¼")
    print("     Logic å®¡æŸ¥ â”€â”€â”€â”€â”€â†’ æ‹’ç»éæ³•è¾“å…¥")
    print("        â”‚")
    print("        â–¼")
    print("     Plot ç¼–å‰§ â†â”€â”€â”€â”€â”€ WS + Vibe æä¾›ä¸Šä¸‹æ–‡")
    print("        â”‚")
    print("        â–¼")
    print("     OS æ‹†åˆ†å‰§æœ¬")
    print("        â”‚")
    print("        â”œâ”€â†’ NPC-A æ¼”ç»")
    print("        â”œâ”€â†’ NPC-B æ¼”ç»")
    print("        â””â”€â†’ ...")
    print("              â”‚")
    print("              â–¼")
    print("     OS æ•´åˆè¾“å‡º â†’ å±•ç¤ºç»™ç©å®¶")
    print()
    print("  â³ æ­¤é˜¶æ®µå°šæœªå®ç°ï¼Œè¯·è¿è¡Œ play_game.pyï¼ˆå¾…å¼€å‘ï¼‰")
    print()
    
    logger.info("é˜¶æ®µ3å°šæœªå®ç°")


def main():
    """ä¸»å‡½æ•°"""
    # è§£æå‘½ä»¤è¡Œå‚æ•°
    parser = argparse.ArgumentParser(
        description="ğŸ­ Infinite Story - æ— é™æ•…äº‹æœº æ¸¸æˆå…¨æµç¨‹è¿è¡Œå…¥å£",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
ç¤ºä¾‹:
  python run_game.py                          # å®Œæ•´æµç¨‹ï¼ˆä»åˆ›ä¸–ç»„å¼€å§‹ï¼‰
  python run_game.py --skip-genesis           # è·³è¿‡åˆ›ä¸–ç»„ï¼ˆä½¿ç”¨ç°æœ‰ä¸–ç•Œï¼‰
  python run_game.py --novel my_novel.txt     # ä½¿ç”¨æŒ‡å®šå°è¯´æ–‡ä»¶
        """
    )
    parser.add_argument(
        "--skip-genesis", 
        action="store_true",
        help="è·³è¿‡åˆ›ä¸–ç»„é˜¶æ®µï¼ˆå¦‚æœä¸–ç•Œæ•°æ®å·²å­˜åœ¨ï¼‰"
    )
    parser.add_argument(
        "--world",
        type=str,
        default=None,
        help="æŒ‡å®šè¦ä½¿ç”¨çš„ä¸–ç•Œåç§°"
    )
    parser.add_argument(
        "--novel",
        type=str,
        default="example_novel.txt",
        help="æŒ‡å®šå°è¯´æ–‡ä»¶åï¼ˆé»˜è®¤: example_novel.txtï¼‰"
    )
    
    args = parser.parse_args()
    
    # æ‰“å°æ¨ªå¹…
    print_banner()
    
    logger.info("=" * 60)
    logger.info("ğŸ® å¯åŠ¨ Infinite Story æ¸¸æˆæµç¨‹")
    logger.info("=" * 60)
    
    # ========================================
    # é˜¶æ®µ1: åˆ›ä¸–ç»„ç¦»çº¿æ„å»º [âœ… å·²å®Œæˆ]
    # ========================================
    if args.world:
        # ä½¿ç”¨æŒ‡å®šçš„ä¸–ç•Œ
        world_dir = settings.DATA_DIR / "worlds" / args.world
        if not world_dir.exists():
            print(f"  âŒ æŒ‡å®šçš„ä¸–ç•Œä¸å­˜åœ¨: {args.world}")
            print(f"  å¯ç”¨çš„ä¸–ç•Œ:")
            worlds_dir = settings.DATA_DIR / "worlds"
            if worlds_dir.exists():
                for w in worlds_dir.iterdir():
                    if w.is_dir() and (w / "world_setting.json").exists():
                        print(f"     - {w.name}")
            sys.exit(1)
        print_stage_header(1, "åˆ›ä¸–ç»„ç¦»çº¿æ„å»º", "â­ï¸ è·³è¿‡")
        print(f"  ğŸ“ ä½¿ç”¨æŒ‡å®šä¸–ç•Œ: {args.world}")
    else:
        world_dir = stage1_genesis(
            novel_filename=args.novel,
            skip=args.skip_genesis
        )
    
    # ========================================
    # é˜¶æ®µ2: åœ¨çº¿åˆå§‹åŒ– [ğŸ”œ å¾…å¼€å‘]
    # ========================================
    stage2_initialize(world_dir)
    
    # ========================================
    # é˜¶æ®µ3: æ¸¸æˆè¿è¡Œ [ğŸ”œ å¾…å¼€å‘]
    # ========================================
    stage3_game_loop(world_dir)
    
    # æ€»ç»“
    print("=" * 70)
    print("  ğŸ“Š æµç¨‹æ€»ç»“")
    print("=" * 70)
    print()
    print("  âœ… é˜¶æ®µ1 - åˆ›ä¸–ç»„ç¦»çº¿æ„å»º: å®Œæˆ")
    print("  ğŸ”œ é˜¶æ®µ2 - åœ¨çº¿åˆå§‹åŒ–: å¾…å¼€å‘ (run_initial.py)")
    print("  ğŸ”œ é˜¶æ®µ3 - æ¸¸æˆè¿è¡Œ: å¾…å¼€å‘ (play_game.py)")
    print()
    print(f"  ğŸ“ ä¸–ç•Œæ•°æ®ä½ç½®: {world_dir}")
    print(f"  ğŸ“‹ è¿è¡Œæ—¥å¿—: {settings.LOGS_DIR}/game_runner.log")
    print()
    print("=" * 70)
    print("  ğŸ‰ æ„Ÿè°¢ä½¿ç”¨ Infinite Story!")
    print("=" * 70)
    print()
    
    logger.info("æ¸¸æˆæµç¨‹ç»“æŸ")


if __name__ == "__main__":
    main()

