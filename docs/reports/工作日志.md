# 📝 工作日志（简化版）

**项目**：AAA-StoryMaker  
**最后更新**：2024年11月25日

---

## 🎯 版本演进

### v2.1 - 数据与逻辑分离（2024-11-25）

**关键改进**：
- ✅ 创建独立的数据层 `utils/character_data.py`
- ✅ 重构 `npc_agent.py` 移除数据处理逻辑
- ✅ 实现低耦合架构，删除40+行重复代码

**技术要点**：
- 使用 `@dataclass` 定义结构化角色数据
- 格式化逻辑集中在 `CharacterDataFormatter`
- 类型安全 + 数据验证

---

### v2.0 - 适配新JSON角色卡格式（2024-11-24）

**关键改进**：
- ✅ 重构所有Agent适配新的JSON格式
- ✅ 新字段：`traits`, `behavior_rules`, `relationship_matrix`, `importance`, `voice_samples`
- ✅ Plot Agent利用importance权重控制角色出场
- ✅ Vibe Agent利用current_appearance进行视觉描写
- ✅ 创建完整的 `example_genesis.json` 示例世界

**设计思想**：
- `importance`权重系统（0-100）控制剧情分配
- `behavior_rules`替代模糊的personality描述
- `relationship_matrix`实现双向社交网络
- `voice_samples`作为few-shot示例提升角色扮演质量

---

### v1.0 - 基础架构搭建（2024-11-24）

**完成内容**：
- ✅ 多层Agent架构设计
- ✅ 离线构建者（Architect）
- ✅ 在线运行系统（OS, Logic, WS, Plot, Vibe, NPC）
- ✅ 消息协议 `message_protocol.py`
- ✅ LLM工厂模式
- ✅ 日志系统

---

## 📂 项目结构（简化版）

```
AAA-StoryMaker/
├── agents/              ← 所有Agent实现
│   ├── offline/         ← 离线构建（Architect）
│   └── online/          ← 在线运行（3层架构）
│       ├── layer1/      ← OS + Logic
│       ├── layer2/      ← WS + Plot + Vibe
│       └── layer3/      ← NPC Agents
├── utils/               ← 工具模块
│   ├── character_data.py  ← 角色数据模型（v2.1新增）
│   ├── llm_factory.py     ← LLM工厂
│   └── logger.py          ← 日志工具
├── config/              ← 配置
├── data/                ← 数据文件
│   ├── genesis/         ← 世界数据
│   ├── novels/          ← 小说原文
│   └── samples/         ← 样本数据
├── prompts/             ← 提示词模板
├── docs/                ← 文档（本文件所在）
└── logs/                ← 运行日志
```

---

## 🎨 核心架构

### 离线构建
- **Architect**：读取小说 → 生成 `Genesis.json`

### 在线运行（3层）

**第一层：安检与中枢**
- **OS**：消息路由、状态管理
- **Logic**：输入/输出验证

**第二层：光明会（决策层）**
- **WS**：世界状态仿真
- **Plot**：剧情控制、导演指令
- **Vibe**：氛围描写

**第三层：演员组**
- **NPC Agents**：沉浸式角色扮演

---

## 🔧 技术栈

- **语言**：Python 3.10+
- **LLM框架**：LangChain
- **LLM提供商**：智谱清言（兼容其他主流LLM）
- **架构原则**：
  - ✅ 数据与逻辑分离
  - ✅ 低耦合设计
  - ✅ 单一职责
  - ✅ 模块化

---

## 📊 关键里程碑

| 日期 | 版本 | 关键成果 |
|-----|------|---------|
| 2024-11-24 | v1.0 | 完成基础架构和多Agent系统 |
| 2024-11-24 | v2.0 | 新JSON格式 + importance权重系统 |
| 2024-11-25 | v2.1 | 数据层分离 + 架构优化 |

---

## 🚀 下一步计划

1. **完善Agent交互流程**
   - 实现完整的游戏回合循环
   - 优化消息传递机制

2. **增强角色系统**
   - 基于importance的动态角色选择
   - relationship_matrix的深度利用

3. **性能优化**
   - LLM调用并发控制
   - 缓存机制

4. **用户体验**
   - CLI交互界面优化
   - 存档/读档功能

---

## 📌 注意事项

- **环境配置**：需要在`.env`文件中配置API密钥
- **虚拟环境**：使用 `venv/` 虚拟环境
- **Git管理**：每次重要改动后都有提交记录
- **文档位置**：
  - 设计文档：`docs/draft.md`
  - 架构说明：`ARCHITECTURE.md`
  - 快速开始：`QUICKSTART.md`
  - 样本数据：`data/samples/`

---

**维护者**：AI Assistant  
**项目状态**：活跃开发中 🟢

