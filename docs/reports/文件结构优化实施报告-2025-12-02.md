# æ–‡ä»¶ç»“æ„ä¼˜åŒ–å®æ–½æŠ¥å‘Š

**å®æ–½æ—¶é—´**: 2025-12-02  
**å®æ–½å†…å®¹**: æŒ‰ç…§ä¼˜åŒ–æ–¹æ¡ˆç»Ÿä¸€æ–‡ä»¶å‘½åè§„åˆ™å’Œç›®å½•ç»“æ„

---

## âœ… å·²å®Œæˆçš„ä¿®æ”¹

### 1. åˆ›å»ºç»Ÿä¸€å‘½åå·¥å…·æ¨¡å—

**æ–‡ä»¶**: `utils/file_naming.py`

æä¾›ç»Ÿä¸€çš„æ–‡ä»¶å‘½åå‡½æ•°ï¼š
- `format_scene_id()` - æ ¼å¼åŒ–åœºæ™¯IDä¸º3ä½æ•°å­—
- `format_plot_archive_name()` - ä¸»å‰§æœ¬å½’æ¡£æ–‡ä»¶å
- `format_actor_script_archive_name()` - è§’è‰²å°å‰§æœ¬å½’æ¡£æ–‡ä»¶å
- `format_actor_current_script_name()` - è§’è‰²å½“å‰å°å‰§æœ¬æ–‡ä»¶å
- `format_actor_history_name()` - è§’è‰²æ¼”ç»å†å²æ–‡ä»¶å
- `format_scene_memory_archive_name()` - åœºæ™¯è®°å¿†å½’æ¡£æ–‡ä»¶å

### 2. ä¿®æ”¹ `os_agent.py`

#### 2.1 å¯¼å…¥å‘½åå·¥å…·
- æ·»åŠ äº† `from utils.file_naming import ...` å¯¼å…¥

#### 2.2 ä¿®æ”¹ `dispatch_script_to_actors()` æ–¹æ³•
- **ç›®å½•ç»“æ„å˜æ›´**:
  - æ—§: `npc/` â†’ æ–°: `actors/scripts/` (å½“å‰å°å‰§æœ¬)
  - æ—§: `npc/history/` â†’ æ–°: `actors/archive/` (å½’æ¡£å°å‰§æœ¬)
- **å‘½åè§„åˆ™å˜æ›´**:
  - æ—§: `npc_003_script.json` â†’ æ–°: `npc_003.json`
  - æ—§: `npc_003_ç¬¬1å¹•å‰§æœ¬.json` â†’ æ–°: `npc_003_scene_001.json`

#### 2.3 ä¿®æ”¹ `_archive_old_script()` æ–¹æ³•
- å‚æ•°å˜æ›´: æ·»åŠ  `scene_id` å‚æ•°
- ä½¿ç”¨æ–°å‘½åè§„åˆ™: `format_actor_script_archive_name()`
- ç›®å½•å˜æ›´: `actors/archive/`

#### 2.4 ä¿®æ”¹ `_archive_plot_files()` æ–¹æ³•
- **ç›®å½•ç»“æ„å˜æ›´**:
  - æ—§: `plot/history/` â†’ æ–°: `plot/archive/`
- **å‘½åè§„åˆ™å˜æ›´**:
  - æ—§: `scene_1_20251202_110021.json` â†’ æ–°: `scene_001.json`
  - æ—§: `script_1_20251202_110021.json` â†’ æ–°: `script_001.json`
- ç§»é™¤æ—¶é—´æˆ³ï¼Œä½¿ç”¨ç»Ÿä¸€çš„æ•°å­—ç¼–å·

#### 2.5 ä¿®æ”¹ `_save_actor_history()` æ–¹æ³•
- **ç›®å½•ç»“æ„å˜æ›´**:
  - æ—§: `npc/npc_003_è¾¾è¾¾æ–¯çš‡å¸/history.json` â†’ æ–°: `actors_history/npc_003.json`
- **æ–°å¢å­—æ®µ**:
  - `scene_id`: ç¬¬å‡ å¹•
  - `turn_in_scene`: è¯¥å¹•ä¸­çš„ç¬¬å‡ æ¬¡å‘è¨€
- æ‰å¹³åŒ–ç»“æ„ï¼Œç§»é™¤è§’è‰²ä¸“å±ç›®å½•

#### 2.6 ä¿®æ”¹ `run_scene_loop()` æ–¹æ³•
- æ·»åŠ  `actor_turn_counts` å­—å…¸è·Ÿè¸ªæ¯ä¸ªè§’è‰²åœ¨å½“å‰åœºæ™¯ä¸­çš„å‘è¨€æ¬¡æ•°
- ä¼ é€’ `scene_id` å’Œ `turn_in_scene` ç»™ `_save_actor_history()`
- æ›´æ–°è„šæœ¬æ–‡ä»¶è·¯å¾„: `actors/scripts/npc_XXX.json`

#### 2.7 ä¿®æ”¹ `get_actor_script()` å’Œ `get_all_actor_scripts()` æ–¹æ³•
- æ›´æ–°è·¯å¾„å¼•ç”¨: `actors/scripts/`
- æ›´æ–°æ–‡ä»¶å‘½åè§„åˆ™

### 3. ä¿®æ”¹ `scene_memory.py`

#### 3.1 ä¿®æ”¹ `SceneMemory` ç±»
- **ç›®å½•ç»“æ„å˜æ›´**:
  - æ—§: `npc/memory/` â†’ æ–°: `scenes/`
- **æ–‡ä»¶å‘½åå˜æ›´**:
  - æ—§: `scene_memory.json` â†’ æ–°: `current.json`
  - æ—§: `scene_memory_turn_1.json` â†’ æ–°: `archive/scene_001.json`

#### 3.2 ä¿®æ”¹ `AllSceneMemory` ç±»
- **ç›®å½•ç»“æ„å˜æ›´**:
  - æ—§: `all_scene_memory.json` â†’ æ–°: `story/all_scenes.json`

#### 3.3 ä¿®æ”¹ `create_scene_memory()` å‡½æ•°
- æ›´æ–°ç›®å½•è·¯å¾„: `scenes/` è€Œä¸æ˜¯ `npc/memory/`

### 4. ä¿®æ”¹æµ‹è¯•æ–‡ä»¶

#### 4.1 `test_three_scenes_flow.py`
- æ›´æ–°è·¯å¾„å¼•ç”¨: `plot/archive/` è€Œä¸æ˜¯ `plot/history/`
- æ›´æ–°è¾“å‡ºä¿¡æ¯ä¸­çš„ç›®å½•åç§°

---

## ğŸ“ æ–°çš„ç›®å½•ç»“æ„

```
data/runtime/ç™½å©çºªæ–‡æ˜_20251202_105155/
â”œâ”€â”€ meta/                          # å…ƒæ•°æ®ï¼ˆæ–°å¢ï¼‰
â”‚   â”œâ”€â”€ init_summary.json
â”‚   â””â”€â”€ test_report.json
â”‚
â”œâ”€â”€ plot/                          # ä¸»å‰§æœ¬
â”‚   â”œâ”€â”€ current_scene.json
â”‚   â”œâ”€â”€ current_script.json
â”‚   â””â”€â”€ archive/                   # ç»Ÿä¸€ä½¿ç”¨ archive
â”‚       â”œâ”€â”€ scene_001.json
â”‚       â”œâ”€â”€ scene_002.json
â”‚       â”œâ”€â”€ script_001.json
â”‚       â””â”€â”€ script_002.json
â”‚
â”œâ”€â”€ actors/                        # è§’è‰²ç›¸å…³ï¼ˆé‡å‘½ånpcä¸ºactorsï¼‰
â”‚   â”œâ”€â”€ scripts/                   # å½“å‰å°å‰§æœ¬
â”‚   â”‚   â”œâ”€â”€ npc_003.json           # ç®€åŒ–å‘½å
â”‚   â”‚   â”œâ”€â”€ npc_004.json
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚
â”‚   â””â”€â”€ archive/                   # è§’è‰²å°å‰§æœ¬å½’æ¡£
â”‚       â”œâ”€â”€ npc_003_scene_001.json # ç»Ÿä¸€æ ¼å¼
â”‚       â”œâ”€â”€ npc_003_scene_002.json
â”‚       â””â”€â”€ ...
â”‚
â”œâ”€â”€ scenes/                        # åœºæ™¯è®°å¿†ï¼ˆä»npc/memoryç§»å‡ºï¼‰
â”‚   â”œâ”€â”€ current.json               # å½“å‰åœºæ™¯è®°å¿†
â”‚   â””â”€â”€ archive/                   # åœºæ™¯è®°å¿†å½’æ¡£
â”‚       â”œâ”€â”€ scene_001.json
â”‚       â””â”€â”€ scene_002.json
â”‚
â”œâ”€â”€ actors_history/                # è§’è‰²æ¼”ç»å†å²ï¼ˆæ‰å¹³åŒ–ï¼‰
â”‚   â”œâ”€â”€ npc_003.json               # ç›´æ¥ä½¿ç”¨è§’è‰²IDå‘½å
â”‚   â”œâ”€â”€ npc_004.json
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ ws/                            # ä¸–ç•ŒçŠ¶æ€
â”‚   â””â”€â”€ world_state.json
â”‚
â”œâ”€â”€ vibe/                          # æ°›å›´
â”‚   â””â”€â”€ initial_atmosphere.json
â”‚
â””â”€â”€ story/                         # å…¨å‰§è®°äº‹æ¿ï¼ˆæ–°å¢ç›®å½•ï¼‰
    â””â”€â”€ all_scenes.json
```

---

## ğŸ“ è§’è‰²æ¼”ç»å†å²JSONç»“æ„ï¼ˆæ–°å¢å­—æ®µï¼‰

```json
{
  "actor_id": "npc_003",
  "actor_name": "è¾¾è¾¾æ–¯çš‡å¸",
  "created_at": "2025-12-02T10:54:54.440335",
  "performances": [
    {
      "turn": 2,                    // å…¨å±€è½®æ¬¡
      "scene_id": 1,                // â­ æ–°å¢ï¼šç¬¬å‡ å¹•
      "turn_in_scene": 1,           // â­ æ–°å¢ï¼šè¯¥å¹•ä¸­çš„ç¬¬å‡ æ¬¡å‘è¨€
      "timestamp": "2025-12-02T10:54:54.440340",
      "thought": "...",
      "emotion": "...",
      "action": "...",
      "content": "...",
      "addressing_target": "npc_006",
      "is_scene_finished": false
    }
  ],
  "last_updated": "2025-12-02T10:59:20.123456",
  "total_performances": 12
}
```

---

## ğŸ”„ å‘½åè§„åˆ™å¯¹ç…§è¡¨

| æ–‡ä»¶ç±»å‹ | æ—§å‘½åè§„åˆ™ | æ–°å‘½åè§„åˆ™ |
|---------|-----------|-----------|
| ä¸»å‰§æœ¬å½’æ¡£ | `script_1_20251202_110021.json` | `script_001.json` |
| ä¸»åœºæ™¯å½’æ¡£ | `scene_1_20251202_110021.json` | `scene_001.json` |
| è§’è‰²å°å‰§æœ¬å½’æ¡£ | `npc_003_ç¬¬1å¹•å‰§æœ¬.json` | `npc_003_scene_001.json` |
| è§’è‰²å½“å‰å°å‰§æœ¬ | `npc_003_script.json` | `npc_003.json` |
| è§’è‰²æ¼”ç»å†å² | `npc/npc_003_è¾¾è¾¾æ–¯çš‡å¸/history.json` | `actors_history/npc_003.json` |
| åœºæ™¯è®°å¿†å½’æ¡£ | `scene_memory_turn_1.json` | `scenes/archive/scene_001.json` |
| åœºæ™¯è®°å¿†å½“å‰ | `scene_memory.json` | `scenes/current.json` |
| å…¨å‰§è®°äº‹æ¿ | `all_scene_memory.json` | `story/all_scenes.json` |

---

## âš ï¸ éœ€è¦æ³¨æ„çš„å…¼å®¹æ€§é—®é¢˜

### å‘åå…¼å®¹
- ä»£ç ä¸­å·²æ›´æ–°æ‰€æœ‰è·¯å¾„å¼•ç”¨
- æ—§æ–‡ä»¶ä¸ä¼šè‡ªåŠ¨è¿ç§»ï¼Œéœ€è¦æ‰‹åŠ¨å¤„ç†æˆ–è¿è¡Œè¿ç§»è„šæœ¬

### æµ‹è¯•æ–‡ä»¶æ›´æ–°
- `test_three_scenes_flow.py` - å·²æ›´æ–°è·¯å¾„å¼•ç”¨
- å…¶ä»–æµ‹è¯•æ–‡ä»¶å¯èƒ½éœ€è¦ç±»ä¼¼æ›´æ–°

### æ–‡æ¡£æ›´æ–°
- `docs/reports/å®Œæ•´æµ‹è¯•æµç¨‹è°ƒç”¨é€»è¾‘å›¾-2025-12-01.md` - éœ€è¦æ›´æ–°è·¯å¾„è¯´æ˜
- `docs/reports/æµ‹è¯•æµç¨‹Mermaidå›¾-2025-12-01.md` - éœ€è¦æ›´æ–°è·¯å¾„è¯´æ˜

---

## ğŸ¯ ä¸‹ä¸€æ­¥å·¥ä½œ

1. **æµ‹è¯•éªŒè¯**: è¿è¡Œå®Œæ•´æµ‹è¯•æµç¨‹ï¼ŒéªŒè¯æ–°ç»“æ„æ­£å¸¸å·¥ä½œ
2. **æ–‡æ¡£æ›´æ–°**: æ›´æ–°æ‰€æœ‰ç›¸å…³æ–‡æ¡£ä¸­çš„è·¯å¾„è¯´æ˜
3. **è¿ç§»è„šæœ¬**: å¯é€‰ï¼Œåˆ›å»ºè„šæœ¬å°†æ—§æ ¼å¼æ–‡ä»¶è¿ç§»åˆ°æ–°æ ¼å¼

---

**çŠ¶æ€**: âœ… ä»£ç ä¿®æ”¹å®Œæˆï¼Œå¾…æµ‹è¯•éªŒè¯







