# 运行时文件结构优化方案

**生成时间**: 2025-12-02  
**分析对象**: `data/runtime/白垩纪文明_20251202_105155/`  
**目标**: 统一命名规则，简化目录结构，提高可读性和可维护性

---

## 📋 当前文件结构分析

### 当前目录结构

```
data/runtime/白垩纪文明_20251202_105155/
├── all_scene_memory.json          # 全剧记事板
├── init_summary.json              # 初始化摘要
├── test_report.json               # 测试报告
│
├── plot/                          # 主剧本相关
│   ├── current_scene.json         # 当前场景配置
│   ├── current_script.json        # 当前剧本内容
│   └── history/                   # 历史归档
│       ├── scene_1_20251202_110021.json
│       ├── scene_2_20251202_110355.json
│       ├── script_1_20251202_110021.json
│       └── script_2_20251202_110355.json
│
├── npc/                           # NPC相关（结构混乱）
│   ├── npc_003_script.json        # 当前小剧本
│   ├── npc_004_script.json
│   ├── npc_005_script.json
│   ├── npc_006_script.json
│   ├── npc_007_script.json
│   │
│   ├── history/                   # 角色小剧本归档（中文命名）
│   │   ├── npc_003_第1幕剧本.json
│   │   ├── npc_003_第2幕剧本.json
│   │   └── ...
│   │
│   ├── memory/                    # 场景记忆
│   │   ├── scene_memory.json      # 当前场景记忆
│   │   └── scene_memory_turn_1.json  # 归档的场景记忆
│   │
│   └── npc_003_达达斯皇帝/        # 角色专属目录
│       └── history.json           # 角色演绎历史
│
├── ws/                            # 世界状态
│   └── world_state.json
│
└── vibe/                          # 氛围
    └── initial_atmosphere.json
```

---

## ❌ 存在的问题

### 1. 命名规则不统一

| 文件类型 | 当前命名 | 问题 |
|---------|---------|------|
| 主剧本归档 | `script_1_20251202_110021.json` | 使用数字+时间戳，不一致 |
| 角色小剧本归档 | `npc_003_第1幕剧本.json` | 使用中文"第X幕"，不一致 |
| 场景记忆归档 | `scene_memory_turn_1.json` | 使用"turn"，不一致 |
| 角色历史 | `history.json` | 文件名太通用，无法区分 |

### 2. 目录结构混乱

- **npc/history/** 和 **npc/npc_003_达达斯皇帝/history.json** 功能重叠但命名不同
- **npc/memory/** 存放场景记忆，但场景记忆应该属于场景级别，不是NPC级别
- 角色专属目录 `npc_003_达达斯皇帝/` 只存放一个 `history.json`，结构过于简单

### 3. 文件命名可读性差

- 时间戳格式 `20251202_110021` 不够直观
- 中文和英文混用（"第1幕" vs "scene_1"）
- 缺少文件类型标识（都是 `.json`，无法快速识别内容）

### 4. 目录层级过深

- `npc/npc_003_达达斯皇帝/history.json` 路径过长
- 角色专属目录只放一个文件，造成目录冗余

---

## ✅ 优化方案

### 方案一：统一命名规则 + 扁平化结构（推荐）

#### 新的目录结构

```
data/runtime/白垩纪文明_20251202_105155/
├── meta/                          # 元数据
│   ├── init_summary.json
│   └── test_report.json
│
├── plot/                          # 主剧本
│   ├── current_scene.json
│   ├── current_script.json
│   └── archive/                   # 统一使用 archive
│       ├── scene_001.json         # 场景归档：scene_XXX.json
│       ├── scene_002.json
│       ├── script_001.json        # 剧本归档：script_XXX.json
│       └── script_002.json
│
├── actors/                        # 角色相关（重命名npc为actors）
│   ├── scripts/                   # 当前小剧本
│   │   ├── npc_003.json           # 简化命名：npc_XXX.json
│   │   ├── npc_004.json
│   │   └── ...
│   │
│   └── archive/                   # 角色小剧本归档
│       ├── npc_003_scene_001.json # 统一格式：npc_XXX_scene_XXX.json
│       ├── npc_003_scene_002.json
│       └── ...
│
├── scenes/                        # 场景记忆（从npc/memory移出）
│   ├── current.json               # 当前场景记忆
│   └── archive/                   # 场景记忆归档
│       ├── scene_001.json         # scene_XXX.json
│       └── scene_002.json
│
├── actors_history/                # 角色演绎历史（扁平化）
│   ├── npc_003.json               # 直接使用角色ID命名
│   ├── npc_004.json
│   └── ...
│
├── ws/                            # 世界状态
│   └── world_state.json
│
├── vibe/                          # 氛围
│   └── initial_atmosphere.json
│
└── story/                         # 全剧记事板
    └── all_scenes.json
```

#### 命名规则

| 文件类型 | 新命名规则 | 示例 |
|---------|-----------|------|
| 主剧本归档 | `script_XXX.json` | `script_001.json` |
| 主场景归档 | `scene_XXX.json` | `scene_001.json` |
| 角色小剧本归档 | `npc_XXX_scene_XXX.json` | `npc_003_scene_001.json` |
| 角色演绎历史 | `npc_XXX.json` | `npc_003.json` |
| 场景记忆归档 | `scene_XXX.json` | `scene_001.json` |

**规则说明**：
- 使用统一的数字编号（001, 002, 003...），不用时间戳
- 使用英文命名，避免中文
- 使用下划线分隔，不使用中文字符
- 文件名包含足够信息，便于识别

---

### 方案二：保持层级结构 + 统一命名（保守）

#### 新的目录结构

```
data/runtime/白垩纪文明_20251202_105155/
├── plot/
│   ├── current_scene.json
│   ├── current_script.json
│   └── archive/
│       ├── scene_001.json
│       ├── scene_002.json
│       ├── script_001.json
│       └── script_002.json
│
├── actors/
│   ├── scripts/                   # 当前小剧本
│   │   ├── npc_003.json
│   │   └── ...
│   │
│   ├── archive/                   # 角色小剧本归档
│   │   ├── npc_003_scene_001.json
│   │   └── ...
│   │
│   └── history/                   # 角色演绎历史（保持层级）
│       ├── npc_003.json
│       └── ...
│
├── scenes/
│   ├── current.json
│   └── archive/
│       ├── scene_001.json
│       └── scene_002.json
│
└── ... (其他目录不变)
```

---

## 🎯 推荐方案：方案一（扁平化）

### 优势

1. **结构清晰**：按功能分类，职责明确
2. **命名统一**：全部使用英文+数字编号
3. **路径简短**：减少目录层级，提高访问效率
4. **易于维护**：文件位置直观，便于查找和管理
5. **可扩展性强**：新增文件类型时规则明确

### 实施步骤

1. **修改代码中的路径生成逻辑**
   - `os_agent.py` 中的 `_archive_plot_files()` 方法
   - `os_agent.py` 中的 `_archive_old_script()` 方法
   - `os_agent.py` 中的 `_save_actor_history()` 方法
   - `scene_memory.py` 中的归档逻辑

2. **统一命名函数**
   - 创建 `utils/file_naming.py` 统一管理命名规则
   - 提供函数：`format_scene_id()`, `format_actor_script_name()` 等

3. **目录结构调整**
   - 将 `npc/` 重命名为 `actors/`
   - 将 `npc/memory/` 移动到 `scenes/`
   - 将角色专属目录扁平化为 `actors_history/`

---

## 📝 具体修改建议

### 1. 创建统一命名工具

```python
# utils/file_naming.py

def format_scene_id(scene_num: int) -> str:
    """格式化场景ID为3位数字"""
    return f"{scene_num:03d}"

def format_actor_script_archive_name(npc_id: str, scene_num: int) -> str:
    """格式化角色小剧本归档文件名"""
    scene_id = format_scene_id(scene_num)
    return f"{npc_id}_scene_{scene_id}.json"

def format_plot_archive_name(file_type: str, scene_num: int) -> str:
    """格式化主剧本归档文件名"""
    scene_id = format_scene_id(scene_num)
    return f"{file_type}_{scene_id}.json"
```

### 2. 修改归档逻辑

- **主剧本归档**：`plot/archive/script_001.json`, `plot/archive/scene_001.json`
- **角色小剧本归档**：`actors/archive/npc_003_scene_001.json`
- **角色历史**：`actors_history/npc_003.json`
- **场景记忆归档**：`scenes/archive/scene_001.json`

### 3. 保持向后兼容

- 添加迁移脚本，将旧格式文件迁移到新格式
- 代码中同时支持新旧两种路径（过渡期）

---

## 🔄 迁移计划

### 阶段1：代码修改（1-2天）
- 创建命名工具模块
- 修改所有文件生成和读取逻辑
- 更新测试脚本

### 阶段2：测试验证（1天）
- 运行完整测试流程
- 验证文件生成正确性
- 检查文件命名一致性

### 阶段3：文档更新（0.5天）
- 更新开发文档
- 更新调用逻辑图
- 添加文件结构说明

---

## 📊 对比总结

| 维度 | 当前方案 | 优化方案 |
|-----|---------|---------|
| 命名一致性 | ❌ 混乱 | ✅ 统一 |
| 目录层级 | ❌ 过深 | ✅ 扁平 |
| 可读性 | ❌ 差 | ✅ 好 |
| 可维护性 | ❌ 低 | ✅ 高 |
| 文件查找 | ❌ 困难 | ✅ 容易 |

---

**建议**: 采用方案一（扁平化结构），统一使用英文+数字编号的命名规则，提高项目的专业性和可维护性。



