name: ci

on:
  push:
    branches: ["main", "master"]
  pull_request:

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
        python-version: ["3.11"]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install fastapi uvicorn

      - name: Prepare .env for CI
        run: |
          python - <<'PY'
          from pathlib import Path
          root = Path('.')
          env_path = root / '.env'
          if not env_path.exists():
              template = root / 'template.env'
              if template.exists():
                  env_path.write_text(template.read_text(encoding='utf-8'), encoding='utf-8')
              else:
                  env_path.write_text('', encoding='utf-8')
          text = env_path.read_text(encoding='utf-8')
          if 'LLM_PROVIDER=' not in text:
              text = 'LLM_PROVIDER=mock\n' + text
          else:
              # Force mock provider for CI
              lines = []
              for line in text.splitlines():
                  if line.startswith('LLM_PROVIDER='):
                      lines.append('LLM_PROVIDER=mock')
                  else:
                      lines.append(line)
              text = '\n'.join(lines) + ('\n' if not text.endswith('\n') else '')
          env_path.write_text(text, encoding='utf-8')
          print('Prepared .env with LLM_PROVIDER=mock')
          PY

      - name: Run tests
        env:
          LLM_PROVIDER: mock
          PYTHONIOENCODING: utf-8
        run: |
          python tests/run_all_tests.py

  docker-build:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4
      - name: Build backend image
        run: docker build -t aaa-storymaker-backend:ci .
      - name: Build frontend image
        run: docker build -t aaa-storymaker-frontend:ci ./frontend
