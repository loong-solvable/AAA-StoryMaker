# 角色重试工具使用示例

## 📋 当前场景

在运行`run_architect.py`构建"未知世界"时，由于API限流（429错误），有2个角色创建失败：
- 李婉 (li_wan)
- 黑衣西装男 (heiyi_xieshang)

这些角色的JSON文件中包含`error`字段而非正常的角色数据。

## 🔧 解决步骤

### 步骤1：激活虚拟环境
```powershell
.\venv\Scripts\activate
```

### 步骤2：运行重试工具
```powershell
python temp/retry_failed_characters.py 未知世界 data/novels/example_novel.txt
```

### 步骤3：查看执行过程
工具会自动：
1. ✅ 扫描"未知世界"文件夹中的所有角色
2. ✅ 识别出包含`error`字段的失败角色
3. ✅ 逐个重试创建这些角色（每次间隔10秒避免限流）
4. ✅ 最多重试3次
5. ✅ 保存成功创建的角色数据

### 步骤4：查看结果

#### 终端输出示例：
```
================================================================================
🔧 角色重试工具 (临时工具)
   用于修复architect因API限流导致的角色创建失败问题
================================================================================
🔧 初始化角色重试工具
📁 世界路径: D:\code\AAA-StoryMaker\data\worlds\未知世界
🏗️  初始化架构师Agent...
✅ 成功加载提示词: 世界观架构师.txt
✅ 成功加载提示词: 角色过滤架构师.txt
✅ 成功加载提示词: 角色制作架构师
✅ 架构师Agent初始化完成
================================================================================
🔍 开始扫描失败的角色...
================================================================================
📋 角色列表中共有 9 个角色
✅ 林晨 (ID: lin_chen): 状态正常
✅ 苏晴雨 (ID: su_qingyu): 状态正常
✅ 张瑞峰 (ID: zhang_ruifeng): 状态正常
⚠️  李婉 (ID: li_wan): 创建失败 - Client error '429 Too Many Requests'
✅ 老记者 (ID: lao_jizhe): 状态正常
✅ 林晨母亲 (ID: lin_chen_mother): 状态正常
✅ 匿名线人 (ID: niming_xianren): 状态正常
✅ 陌生号码男性 (ID: mosheng_nanxing): 状态正常
⚠️  黑衣西装男 (ID: heiyi_xieshang): 创建失败 - Client error '429 Too Many Requests'
================================================================================
📊 扫描结果: 发现 2 个失败的角色
   - 李婉 (ID: li_wan, 重要性: 0.5)
   - 黑衣西装男 (ID: heiyi_xieshang, 重要性: 0.1)
================================================================================
✅ 已加载小说文件 (8156 字符)
================================================================================
🔄 开始重试失败的角色
   - 重试延迟: 10 秒
   - 最大重试次数: 3
================================================================================
📍 [1/3] 尝试重试: 李婉
🔄 开始重试角色: 李婉 (ID: li_wan)
⏰ 等待 10 秒以避免API限流...
🤖 正在调用LLM创建角色档案...
✅ 李婉 档案重新创建成功！
📍 [1/3] 尝试重试: 黑衣西装男
🔄 开始重试角色: 黑衣西装男 (ID: heiyi_xieshang)
⏰ 等待 10 秒以避免API限流...
🤖 正在调用LLM创建角色档案...
✅ 黑衣西装男 档案重新创建成功！
================================================================================
📊 重试完成！最终结果：
   ✅ 成功: 2 个角色
   ❌ 失败: 0 个角色
================================================================================
```

#### 日志文件：
查看详细日志：`logs/character_retry.log`

#### 验证角色文件：
```powershell
# 查看李婉的角色文件（应该不再包含error字段）
cat data/worlds/未知世界/characters/character_li_wan.json

# 查看黑衣西装男的角色文件
cat data/worlds/未知世界/characters/character_heiyi_xieshang.json
```

## ⚙️ 高级配置

如果仍然遇到限流问题，可以修改`temp/retry_failed_characters.py`中的参数：

```python
# 在main()函数中找到这些参数
tool.run_retry(
    novel_path=novel_path,
    retry_delay=20,  # 增加延迟到20秒
    max_retries=5    # 增加最大重试次数到5次
)
```

## 🎯 何时使用这个工具

- ✅ 运行architect后发现某些角色文件包含`error`字段
- ✅ 日志中出现429 Too Many Requests错误
- ✅ 想要补全缺失的角色数据

## ⚠️ 注意事项

1. **此工具是临时性的**：将来项目会支持多LLM负载均衡，届时不再需要手动重试
2. **需要原始小说文件**：重试时需要完整的小说文本来生成角色数据
3. **请耐心等待**：工具会自动添加延迟避免限流，整个过程可能需要几分钟
4. **检查API配额**：如果持续失败，请确认API配额是否充足

## 📚 相关文件

- 工具脚本：`temp/retry_failed_characters.py`
- 日志文件：`logs/character_retry.log`
- 世界数据：`data/worlds/未知世界/`
- 角色列表：`data/worlds/未知世界/characters_list.json`
- 角色文件：`data/worlds/未知世界/characters/character_*.json`

